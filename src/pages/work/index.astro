---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { getCollection } from "astro:content";

async function safeCollection(name) {
	try {
		return await getCollection(name);
	} catch {
		return [];
	}
}

let projects = (await safeCollection("projects")).filter((e) => !e.data.draft);
projects.sort((a, b) => (b.data.date?.valueOf?.() ?? 0) - (a.data.date?.valueOf?.() ?? 0));
const featuredProjects = (projects.filter((p) => p.data.selected).length ? projects.filter((p) => p.data.selected) : projects).slice(0, 3);

let publications = (await safeCollection("publications")).filter((e) => !e.data.draft);
publications.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const featuredPubs = (publications.filter((p) => p.data.selected).length ? publications.filter((p) => p.data.selected) : publications).slice(0, 3);

let talks = (await safeCollection("talks")).filter((e) => !e.data.draft);
talks.sort((a, b) => b.data.date.valueOf() - a.data.date.valueOf());
const featuredTalks = (talks.filter((t) => t.data.selected).length ? talks.filter((t) => t.data.selected) : talks).slice(0, 3);

let teaching = (await safeCollection("teaching")).filter((e) => !e.data.draft);
teaching.sort((a, b) => String(b.data.term).localeCompare(String(a.data.term)));
const featuredTeaching = teaching.slice(0, 3);
---

<SiteLayout title="Work" description="Projects, publications, talks, and teaching.">
	<div class="space-y-10">
		<section class="max-w-2xl">
			<h1>Work</h1>
			<p class="mt-4 text-base leading-7 text-zinc-800">
				A single place to browse projects, publications, talks, and teaching.
			</p>
		</section>

		<div class="grid gap-6 lg:grid-cols-2">
			<section class="rounded-2xl border border-zinc-200/80 bg-white p-6 shadow-sm">
				<div class="prose max-w-none">
					<h2>Projects</h2>
					<ul>
						{featuredProjects.map((p) => (
							<li>
								<a href={`/projects/${p.slug}/`}>{p.data.title}</a>
								{p.data.summary ? <div class="text-zinc-700">{p.data.summary}</div> : null}
							</li>
						))}
					</ul>
					<p><a href="/projects/">Browse all projects</a></p>
				</div>
			</section>

			<section class="rounded-2xl border border-zinc-200/80 bg-white p-6 shadow-sm">
				<div class="prose max-w-none">
					<h2>Publications</h2>
					<ul>
						{featuredPubs.map((p) => (
							<li>
								<a href={`/publications/${p.slug}/`}>{p.data.title}</a>
								{p.data.authors || p.data.venue ? (
									<div class="text-zinc-700">
										{p.data.authors ? `${p.data.authors}${p.data.venue ? " • " : ""}` : ""}
										{p.data.venue ?? ""}
									</div>
								) : null}
							</li>
						))}
					</ul>
					<p><a href="/publications/">Browse all publications</a></p>
				</div>
			</section>

			<section class="rounded-2xl border border-zinc-200/80 bg-white p-6 shadow-sm">
				<div class="prose max-w-none">
					<h2>Talks</h2>
					<ul>
						{featuredTalks.map((t) => (
							<li>
								<a href={`/talks/${t.slug}/`}>{t.data.title}</a>
								{t.data.event || t.data.location ? (
									<div class="text-zinc-700">
										{t.data.event ? `${t.data.event}${t.data.location ? " • " : ""}` : ""}
										{t.data.location ?? ""}
									</div>
								) : null}
							</li>
						))}
					</ul>
					<p><a href="/talks/">Browse all talks</a></p>
				</div>
			</section>

			<section class="rounded-2xl border border-zinc-200/80 bg-white p-6 shadow-sm">
				<div class="prose max-w-none">
					<h2>Teaching</h2>
					<ul>
						{featuredTeaching.map((c) => (
							<li>
								<a href={`/teaching/${c.slug}/`}>{c.data.course}</a>
								<div class="text-zinc-700">
									{c.data.term}{c.data.institution ? ` • ${c.data.institution}` : ""}{c.data.role ? ` • ${c.data.role}` : ""}
								</div>
							</li>
						))}
					</ul>
					<p><a href="/teaching/">Browse all teaching</a></p>
				</div>
			</section>
		</div>
	</div>
</SiteLayout>
