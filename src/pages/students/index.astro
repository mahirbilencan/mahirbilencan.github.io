---
import SiteLayout from "../../layouts/SiteLayout.astro";
import { getCollection } from "astro:content";

let entries = [];
try {
	entries = await getCollection("students");
} catch {
	entries = [];
}

const students = entries.filter((entry) => !entry.data.draft);

function extractYears(value: string) {
	return (value.match(/\d{4}/g) ?? []).map((item) => Number(item));
}

function firstYear(value: string) {
	const years = extractYears(value);
	return years[0] ?? 0;
}

function lastYear(value: string) {
	const years = extractYears(value);
	return years[years.length - 1] ?? 0;
}

const currentStudents = students
	.filter((entry) => entry.data.status === "current")
	.sort((a, b) => firstYear(b.data.years) - firstYear(a.data.years));

const alumni = students
	.filter((entry) => entry.data.status === "alumni")
	.sort((a, b) => {
		const byYear = lastYear(b.data.years) - lastYear(a.data.years);
		if (byYear !== 0) return byYear;
		return a.data.name.localeCompare(b.data.name);
	});
---

<SiteLayout title="Students">
	<section class="space-y-8">
		<div class="space-y-3">
			<p class="text-xs uppercase tracking-[0.2em] text-emerald-700">Mentorship</p>
			<h1 class="text-4xl font-semibold leading-tight sm:text-5xl">Graduate student archive</h1>
			<p class="max-w-3xl text-[15px] leading-7 text-[#2c3a40]">
				Current and former graduate students, including advising timelines and degree information.
			</p>
		</div>

		<div class="grid gap-8">
			<section class="rounded-2xl border border-stone-200 bg-white p-6 shadow-sm ring-1 ring-stone-200">
				<div class="mb-4 flex flex-wrap items-center justify-between gap-3">
					<h2 class="text-2xl font-semibold leading-tight">Current students</h2>
					<span class="pill bg-stone-100/70 text-emerald-900">{currentStudents.length} active</span>
				</div>
				{currentStudents.length === 0 ? (
					<p class="rounded-xl bg-stone-100/70 p-4 text-sm text-[#2c3a40] ring-1 ring-stone-200">No current students listed.</p>
				) : (
					<ul class="grid gap-3">
						{currentStudents.map((entry) => (
							<li class="rounded-xl bg-stone-100/70 p-4 ring-1 ring-stone-200">
								<div class="flex flex-wrap items-center gap-2">
									<p class="text-base font-semibold text-[#0f2c24]">{entry.data.name}</p>
									<span class="pill bg-white text-emerald-900">{entry.data.degree}</span>
									<span class="pill bg-white text-[#2c3a40]">{entry.data.years}</span>
								</div>
								{entry.data.coAdvisor && (
									<p class="mt-2 text-sm text-[#2c3a40]">Co-advisor: {entry.data.coAdvisor}</p>
								)}
								{entry.data.note && <p class="mt-1 text-sm text-[#2c3a40]">{entry.data.note}</p>}
							</li>
						))}
					</ul>
				)}
			</section>

			<section class="rounded-2xl border border-stone-200 bg-white p-6 shadow-sm ring-1 ring-stone-200">
				<div class="mb-4 flex flex-wrap items-center justify-between gap-3">
					<h2 class="text-2xl font-semibold leading-tight">Alumni</h2>
					<span class="pill bg-stone-100/70 text-emerald-900">{alumni.length} listed</span>
				</div>
				{alumni.length === 0 ? (
					<p class="rounded-xl bg-stone-100/70 p-4 text-sm text-[#2c3a40] ring-1 ring-stone-200">No alumni listed yet.</p>
				) : (
					<ul class="grid gap-3 sm:grid-cols-2">
						{alumni.map((entry) => (
							<li class="rounded-xl bg-stone-100/70 p-4 ring-1 ring-stone-200">
								<p class="text-base font-semibold text-[#0f2c24]">{entry.data.name}</p>
								<div class="mt-2 flex flex-wrap gap-2">
									<span class="pill bg-white text-emerald-900">{entry.data.degree}</span>
									<span class="pill bg-white text-[#2c3a40]">{entry.data.years}</span>
								</div>
								{entry.data.currentPosition && (
									<p class="mt-2 text-sm text-[#2c3a40]">Current position: {entry.data.currentPosition}</p>
								)}
								{entry.data.thesis && <p class="mt-1 text-sm text-[#2c3a40]">Thesis: {entry.data.thesis}</p>}
							</li>
						))}
					</ul>
				)}
			</section>
		</div>
	</section>
</SiteLayout>
